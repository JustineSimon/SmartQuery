<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartQuery Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>  
  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="menu-top">
        <h2>SmartQuery</h2>
        <ul>
          <li><a href="home.html"><img src="images/homeicon.png" class="icon" /> Home</a></li>
          <li class="active"><a href="dashboard.html"><img src="images/adminicon.png" class="icon" /> Admin Dashboard</a></li>
        </ul>
      </div>
      <ul class="logout">
        <li><a href="logout.html"><img src="images/logouticon.png" class="icon" /> Logout</a></li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <header>
        <h1>Admin Dashboard</h1>
        <button id="refreshBtn" class="refresh-btn">Refresh</button>
      </header>

      <div class="cards">
        <div class="card"><h3>Total Tickets</h3><p id="totalCount" class="number">0</p></div>
        <div class="card"><h3>Open Tickets</h3><p id="openCount" class="number">0</p></div>
        <div class="card"><h3>In Progress</h3><p id="inProgressCount" class="number">0</p></div>
        <div class="card"><h3>Resolved</h3><p id="resolvedCount" class="number">0</p></div>
      </div>

      <div class="bottom-section">
        <div class="tickets">
          <h2>Support Tickets</h2>
          <table id="ticketsTable">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Subject</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Created</th>
                <th>Ticket ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="adminTicketTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
async function loadAllTickets() {
  try {
    const response = await fetch('backend/get_all_tickets.php');
    const data = await response.json();

    const tableBody = document.getElementById('adminTicketTableBody');
    tableBody.innerHTML = '';

    if (!data.success) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">${data.message}</td></tr>`;
      return;
    }

    if (data.tickets.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No tickets found.</td></tr>`;
      return;
    }

    data.tickets.forEach(ticket => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ticket.username}</td>
        <td>${ticket.subject}</td>
        <td>${ticket.status}</td>
        <td>${ticket.priority}</td>
        <td>${ticket.created_at}</td>
        <td>${ticket.id}</td>
        <td><button class="view-btn" data-id="${ticket.id}">View</button></td>
      `;
      tableBody.appendChild(row);
    });

    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const ticketId = btn.dataset.id;
        // Open the ticket view page in a popup window
        window.open(`ticket_view.html?id=${ticketId}`, '_blank', 'width=700,height=700');
      });
    });

  } catch (err) {
    console.error('Fetch error:', err);
    document.getElementById('adminTicketTableBody').innerHTML =
      `<tr><td colspan="7" style="text-align:center;">Error loading tickets</td></tr>`;
  }
}

document.addEventListener('DOMContentLoaded', loadAllTickets);
document.getElementById('refreshBtn').addEventListener('click', loadAllTickets);
</script>
</body>
</html>
