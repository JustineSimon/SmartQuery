<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SmartQuery Admin Dashboard</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>  
  <div class="dashboard">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <div class="menu-top">
        <h2>SmartQuery</h2>
        <ul>
          <li><a href="home.html"><img src="images/homeicon.png" class="icon" /> Home</a></li>
          <li class="active"><a href="dashboard.html"><img src="images/adminicon.png" class="icon" /> Admin Dashboard</a></li>
        </ul>
      </div>
      <ul class="logout">
        <li><a href="logout.html"><img src="images/logouticon.png" class="icon" /> Logout</a></li>
      </ul>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main">
      <header>
        <h1>Admin Dashboard</h1>
        <button id="refreshBtn" class="refresh-btn">Refresh</button>
      </header>

      <div class="cards">
        <div class="card"><h3>Total Tickets</h3><p id="totalCount" class="number">0</p></div>
        <div class="card"><h3>Open Tickets</h3><p id="openCount" class="number">0</p></div>
        <div class="card"><h3>In Progress</h3><p id="inProgressCount" class="number">0</p></div>
        <div class="card"><h3>Resolved</h3><p id="resolvedCount" class="number">0</p></div>
      </div>

      <div class="bottom-section">
        <div class="tickets">
          <h2>Support Tickets</h2>
          <table id="ticketsTable">
            <thead>
              <tr>
                <th>Customer</th>
                <th>Category</th>
                <th>Status</th>
                <th>Priority</th>
                <th>Created</th>
                <th>Ticket ID</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="adminTicketTableBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
async function loadAllTickets() {
  try {
    const response = await fetch('backend/get_all_tickets.php');
    const data = await response.json();

    const tableBody = document.getElementById('adminTicketTableBody');
    tableBody.innerHTML = '';

    if (!data.success) {
      tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">${data.message}</td></tr>`;
      return;
    }

    if (data.tickets.length === 0) {
      tableBody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No tickets found.</td></tr>`;
      document.getElementById('totalCount').textContent = 0;
      document.getElementById('openCount').textContent = 0;
      document.getElementById('inProgressCount').textContent = 0;
      document.getElementById('resolvedCount').textContent = 0;
      return;
    }

    // 🟢 Normalize statuses (works for “Pending”, “Ongoing”, etc.)
    let open = 0, inProgress = 0, resolved = 0;
    data.tickets.forEach(t => {
      const status = (t.status || '').toLowerCase();
      if (status.includes('open') || status.includes('new') || status.includes('pending')) open++;
      else if (status.includes('progress') || status.includes('ongoing')) inProgress++;
      else if (status.includes('resolved') || status.includes('closed') || status.includes('done')) resolved++;
    });

    // 🟢 Update summary counters
    document.getElementById('totalCount').textContent = data.tickets.length;
    document.getElementById('openCount').textContent = open;
    document.getElementById('inProgressCount').textContent = inProgress;
    document.getElementById('resolvedCount').textContent = resolved;

    // 🟢 Populate rows (with dropdowns)
    data.tickets.forEach(ticket => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${ticket.username}</td>
        <td>
          <select class="category-select" data-id="${ticket.id}">
            <option value="Refund" ${ticket.category === 'Refund' ? 'selected' : ''}>Refund</option>
            <option value="Service concern" ${ticket.category === 'Service concern' ? 'selected' : ''}>Service concern</option>
            <option value="Support" ${ticket.category === 'Support' ? 'selected' : ''}>Support</option>
          </select>
        </td>
        <td>${ticket.status}</td>
        <td>
          <select class="priority-select" data-id="${ticket.id}">
            <option value="Urgent" ${ticket.priority === 'Urgent' ? 'selected' : ''}>Urgent</option>
            <option value="Normal" ${ticket.priority === 'Normal' ? 'selected' : ''}>Normal</option>
            <option value="Not urgent" ${ticket.priority === 'Not urgent' ? 'selected' : ''}>Not urgent</option>
          </select>
        </td>
        <td>${ticket.created_at}</td>
        <td>${ticket.id}</td>
        <td><button class="view-btn" data-id="${ticket.id}">View</button></td>
      `;
      tableBody.appendChild(row);
    });

    // 🟢 View button event
    document.querySelectorAll('.view-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const ticketId = btn.dataset.id;
        window.open(`ticket_view.html?id=${ticketId}`, '_blank', 'width=700,height=700');
      });
    });

    // 🟢 Dropdown change events for updating
    document.querySelectorAll('.priority-select').forEach(select => {
      select.addEventListener('change', () => {
        updateTicketField(select.dataset.id, 'priority', select.value);
      });
    });

    document.querySelectorAll('.category-select').forEach(select => {
      select.addEventListener('change', () => {
        updateTicketField(select.dataset.id, 'category', select.value);
      });
    });

  } catch (err) {
    console.error('Fetch error:', err);
    document.getElementById('adminTicketTableBody').innerHTML =
      `<tr><td colspan="8" style="text-align:center;">Error loading tickets</td></tr>`;
  }
}

// 🟢 Update field helper function
async function updateTicketField(ticketId, field, value) {
  try {
    const response = await fetch('backend/update_ticket_fields.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ ticket_id: ticketId, field, value })
    });

    const result = await response.json();
    if (!result.success) {
      alert('Failed to update: ' + result.message);
    }
  } catch (err) {
    console.error('Error updating ticket:', err);
  }
}

document.addEventListener('DOMContentLoaded', loadAllTickets);
document.getElementById('refreshBtn').addEventListener('click', loadAllTickets);
</script>

</body>
</html>
